<h1>Game #<%= @game.id %></h1>

<p><%= link_to "Back to Games", games_path %></p>

<% if flash[:alert] %>
  <p style="color: red;"><%= flash[:alert] %></p>
<% end %>

<h2>Players</h2>
<p><%= @game.players.join(", ") %></p>

<% sorted_scores = @game.scores.sort_by { |_, score| -score } %>
<% leader = sorted_scores.first&.first %>

<h2>Scores</h2>
<table border="1" cellpadding="5">
  <tr>
    <% sorted_scores.each do |player, _| %>
      <th><%= player %><%= " ğŸ†" if @game.complete? && player == leader %></th>
    <% end %>
  </tr>
  <tr>
    <% sorted_scores.each do |_, score| %>
      <td><%= score %></td>
    <% end %>
  </tr>
</table>

<h2>Rounds</h2>

<% @game.rounds.each_with_index do |round, idx| %>
  <h3>Round <%= idx + 1 %> (<%= round.cards_dealt %> cards)</h3>

  <table border="1" cellpadding="5">
    <tr>
      <th>Player</th>
      <th>Asked</th>
      <th>Made</th>
      <th>Points</th>
    </tr>
    <% round.players_in_order.each do |player| %>
      <tr>
        <td><%= player %></td>
        <% input_id_asked = "r#{idx}-#{player.parameterize}-asked" %>
        <% input_id_made = "r#{idx}-#{player.parameterize}-made" %>
        <td>
          <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
            <input type="hidden" name="round" value="<%= idx %>">
            <input type="hidden" name="player" value="<%= player %>">
            <input type="hidden" name="focus" value="<%= input_id_asked %>">
            <input type="number" name="asked" id="<%= input_id_asked %>" value="<%= round.bids[player] %>" min="0" max="<%= round.cards_dealt %>" style="width: 50px;"
              data-action="change->autosubmit#submit keydown.enter->autosubmit#submitOnEnter"
              <%= "autofocus" if params[:focus] == input_id_asked %>>
            <% if round.bidding? && !round.bids[player] && round.forbidden_number %>
              <small>(not <%= round.forbidden_number %>)</small>
            <% end %>
          <% end %>
        </td>
        <td>
          <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
            <input type="hidden" name="round" value="<%= idx %>">
            <input type="hidden" name="player" value="<%= player %>">
            <input type="hidden" name="focus" value="<%= input_id_made %>">
            <input type="number" name="made" id="<%= input_id_made %>" value="<%= round.tricks_won[player] %>" min="0" max="<%= round.cards_dealt %>" style="width: 50px;"
              data-action="change->autosubmit#submit keydown.enter->autosubmit#submitOnEnter"
              <%= "autofocus" if params[:focus] == input_id_made %>>
          <% end %>
        </td>
        <td><%= round.points_for(player) %></td>
      </tr>
    <% end %>
  </table>

  <% if round.complete? %>
    <p>
      Total asked: <%= round.total_bids %> / <%= round.cards_dealt %>
      <%= round.valid? ? "âœ…" : "âŒ" %>
    </p>
  <% elsif round.bidding? %>
    <p>ğŸ—£ï¸ Bidding - waiting for <%= round.current_bidder %></p>
  <% elsif round.playing? %>
    <p>ğŸƒ Playing - record tricks</p>
  <% end %>
<% end %>
