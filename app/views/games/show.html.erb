<header class="sticky-header">
  <h1>Partida #<%= @game.id %></h1>
  <p><%= link_to "â† Volver", games_path %></p>

  <% if flash[:alert] %>
    <p role="alert"><%= flash[:alert] %></p>
  <% end %>

  <% sorted_scores = @game.scores.sort_by { |_, score| -score } %>
  <% leader = sorted_scores.first&.first %>

  <table class="scores-table">
  <tr>
    <% sorted_scores.each do |player, _| %>
      <th><%= player %><%= " ğŸ†" if @game.complete? && player == leader %></th>
    <% end %>
  </tr>
  <tr>
    <% sorted_scores.each do |_, score| %>
      <td><%= score %></td>
    <% end %>
  </tr>
</table>
</header>

<h2>Rondas</h2>

<% @game.rounds.each_with_index do |round, idx| %>
  <h3>Ronda <%= idx + 1 %> (<%= round.cards_dealt %> <%= round.cards_dealt == 1 ? "carta" : "cartas" %>)</h3>

  <table>
    <thead>
      <tr>
        <th>Jugador</th>
        <th>Pedidas</th>
        <th>Hechas</th>
        <th>Puntos</th>
      </tr>
    </thead>
    <tbody>
      <% round.players_in_order.each do |player| %>
        <% forbidden = round.bidding? && !round.bids[player] ? round.forbidden_number : nil %>
        <tr>
          <td><%= player %></td>
          <td>
            <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
              <input type="hidden" name="round" value="<%= idx %>">
              <input type="hidden" name="player" value="<%= player %>">
              <%= select_tag :asked, options_for_select(bid_options(max: round.cards_dealt, forbidden:), round.bids[player]),
                include_blank: "-",
                data: { action: "change->autosubmit#submit" } %>
            <% end %>
          </td>
          <td>
            <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
              <input type="hidden" name="round" value="<%= idx %>">
              <input type="hidden" name="player" value="<%= player %>">
              <%= select_tag :made, options_for_select(bid_options(max: round.cards_dealt), round.tricks_won[player]),
                include_blank: "-",
                data: { action: "change->autosubmit#submit" } %>
            <% end %>
          </td>
          <td><%= round.points_for(player) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if round.complete? %>
    <p>
      Total pedidas: <%= round.total_bids %> / <%= round.cards_dealt %>
      <%= round.valid? ? "âœ…" : "âŒ" %>
    </p>
  <% elsif round.bidding? %>
    <p>ğŸ—£ï¸ Pidiendo - esperando a <%= round.current_bidder %></p>
  <% elsif round.playing? %>
    <p>ğŸƒ Jugando - registrar bazas</p>
  <% end %>
<% end %>
