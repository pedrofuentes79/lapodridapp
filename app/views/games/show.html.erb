<h1>Partida #<%= @game.id %></h1>

<p><%= link_to "Volver a partidas", games_path %></p>

<% if flash[:alert] %>
  <p style="color: red;"><%= flash[:alert] %></p>
<% end %>

<h2>Jugadores</h2>
<p><%= @game.players.join(", ") %></p>

<% sorted_scores = @game.scores.sort_by { |_, score| -score } %>
<% leader = sorted_scores.first&.first %>

<h2>Puntajes</h2>
<table border="1" cellpadding="5">
  <tr>
    <% sorted_scores.each do |player, _| %>
      <th><%= player %><%= " ğŸ†" if @game.complete? && player == leader %></th>
    <% end %>
  </tr>
  <tr>
    <% sorted_scores.each do |_, score| %>
      <td><%= score %></td>
    <% end %>
  </tr>
</table>

<h2>Rondas</h2>

<% @game.rounds.each_with_index do |round, idx| %>
  <h3>Ronda <%= idx + 1 %> (<%= round.cards_dealt %> <%= round.cards_dealt == 1 ? "carta" : "cartas" %>)</h3>

  <table border="1" cellpadding="5">
    <tr>
      <th>Jugador</th>
      <th>Pedidas</th>
      <th>Hechas</th>
      <th>Puntos</th>
    </tr>
    <% round.players_in_order.each do |player| %>
      <% forbidden = round.bidding? && !round.bids[player] ? round.forbidden_number : nil %>
      <tr>
        <td><%= player %></td>
        <td>
          <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
            <input type="hidden" name="round" value="<%= idx %>">
            <input type="hidden" name="player" value="<%= player %>">
            <%= select_tag :asked, options_for_select(bid_options(max: round.cards_dealt, forbidden:), round.bids[player]),
              include_blank: "-",
              data: { action: "change->autosubmit#submit" } %>
          <% end %>
        </td>
        <td>
          <%= form_with url: bid_game_path(@game), method: :post, local: true, data: { controller: "autosubmit" } do %>
            <input type="hidden" name="round" value="<%= idx %>">
            <input type="hidden" name="player" value="<%= player %>">
            <%= select_tag :made, options_for_select(bid_options(max: round.cards_dealt), round.tricks_won[player]),
              include_blank: "-",
              data: { action: "change->autosubmit#submit" } %>
          <% end %>
        </td>
        <td><%= round.points_for(player) %></td>
      </tr>
    <% end %>
  </table>

  <% if round.complete? %>
    <p>
      Total pedidas: <%= round.total_bids %> / <%= round.cards_dealt %>
      <%= round.valid? ? "âœ…" : "âŒ" %>
    </p>
  <% elsif round.bidding? %>
    <p>ğŸ—£ï¸ Pidiendo - esperando a <%= round.current_bidder %></p>
  <% elsif round.playing? %>
    <p>ğŸƒ Jugando - registrar bazas</p>
  <% end %>
<% end %>
