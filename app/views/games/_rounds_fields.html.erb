<% game_for_calc = Game.new %>

<div class="rounds-list" data-rounds-form-target="list">
  <% rounds_params.each_with_index do |round, idx| %>
    <% has_trump = !!round[:has_trump] %>
    <% max_cards = player_count.to_i > 0 ? game_for_calc.maximum_cards_dealt_for_players(player_count.to_i, has_trump: has_trump) : 0 %>
    <% cards_val = round[:cards_dealt].to_s.strip %>
    <% cards_num = cards_val.present? ? cards_val.to_i : nil %>
    <% over_max = cards_num.present? && cards_num > max_cards %>

    <div class="round-row <%= "over-max" if over_max %>">
      <div class="round-input">
        <div class="field">
          <%= label_tag "rounds_#{idx}_cards_dealt", "Ronda #{idx + 1}" %>
          <%= number_field_tag "rounds[#{idx}][cards_dealt]",
            round[:cards_dealt].to_s,
            id: "rounds_#{idx}_cards_dealt",
            min: 0,
            data: { rounds_form_target: "cardsInput", action: "keydown.enter->rounds-form#maybeAdd" },
            placeholder: "Cantidad de cartas"
          %>
        </div>
        <div class="hint">
          Max: <strong><%= max_cards %></strong>
          <% if over_max %>
            â€” <strong>too high</strong>
          <% end %>
        </div>
      </div>

      <div class="round-trump">
        <%= hidden_field_tag "rounds[#{idx}][has_trump]", "0" %>
        <%= check_box_tag "rounds[#{idx}][has_trump]", "1", has_trump, id: "rounds_#{idx}_has_trump" %>
        <%= label_tag "rounds_#{idx}_has_trump", "Has trump" %>
      </div>
    </div>
  <% end %>
</div>


